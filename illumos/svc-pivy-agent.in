#!/sbin/sh

. /lib/svc/share/smf_include.sh

set -e

getprop() {
	prop="$1"
	/usr/bin/svcprop -p "$prop" $SMF_FMRI
}

getprop_default() {
	prop="$1"
	default="$2"
	/usr/bin/svcprop -p "$prop" $SMF_FMRI 2>/dev/null || echo "$default"
}

GUID="`getprop config/guid`"
CAK="`getprop config/cak | sed 's/\\\\ / /'`"
SOCKET="`getprop config/socket`"
SSH_ASKPASS="`getprop_default config/askpass ''`"
if [ -n "$SSH_ASKPASS" ]; then
	export SSH_ASKPASS
fi

OPTS=""

ANY_UID="`getprop_default config/allow_any_uid false`"
if [ "$ANY_UID" == "true" ]; then
	OPTS="${OPTS} -U"
fi

ANY_ZONE="`getprop_default config/allow_any_zone false`"
if [ "$ANY_ZONE" == "true" ]; then
	OPTS="${OPTS} -Z"
fi

ALLOWED_USERS="`getprop_default config/allowed_users ''`"
if [ -n "$ALLOWED_USERS" ]; then
	IFS=', '
	for user in $ALLOWED_USERS; do
		OPTS="${OPTS} -u ${user}"
	done
fi

ALLOWED_ZONES="`getprop_default config/allowed_zones ''`"
if [ -n "$ALLOWED_ZONES" ]; then
	IFS=', '
	for zone in $ALLOWED_ZONES; do
		OPTS="${OPTS} -z ${zone}"
	done
fi

SLOT_FILTER="`getprop_default config/slot_filter ''`"
if [ -n "${SLOT_FILTER}" ]; then
	OPTS="${OPTS} -S ${SLOT_FILTER}"
fi

SOCKET_OWNER="`getprop_default config/socket_owner ''`"
SOCKET_MODE="`getprop_default config/socket_mode ''`"

@@prefix@@/bin/pivy-agent -i -g "$GUID" -K "$CAK" -a "$SOCKET" $OPTS &

if [ -n "${SOCKET_OWNER}" ]; then
	/usr/bin/chown ${SOCKET_OWNER} ${SOCKET}
fi
if [ -n "${SOCKET_MODE}" ]; then
	/usr/bin/chmod ${SOCKET_MODE} ${SOCKET}
fi

exit $SMF_EXIT_OK
