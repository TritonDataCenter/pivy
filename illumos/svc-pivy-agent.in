#!/sbin/sh

. /lib/svc/share/smf_include.sh

set -e

getprop() {
	prop="$1"
	/usr/bin/svcprop -p "$prop" $SMF_FMRI
}

getprop_default() {
	prop="$1"
	default="$2"
	/usr/bin/svcprop -p "$prop" $SMF_FMRI 2>/dev/null || echo "$default"
}

GUID="`getprop config/guid`"
CAK="`getprop config/cak | sed 's/\\\\ / /'`"
SOCKET="`getprop config/socket`"
SSH_ASKPASS="`getprop_default config/askpass ''`"
if [ -n "$SSH_ASKPASS" ]; then
	export SSH_ASKPASS
fi

OPTS=""

ANY_UID="`getprop_default config/allow_any_uid false`"
if [ "$ANY_UID" == "true" ]; then
	OPTS="${OPTS} -U"
fi

ANY_ZONE="`getprop_default config/allow_any_zone false`"
if [ "$ANY_ZONE" == "true" ]; then
	OPTS="${OPTS} -Z"
fi

SLOT_FILTER="`getprop_default config/slot_filter ''`"
if [ -n "${SLOT_FILTER}" ]; then
	OPTS="${OPTS} -S ${SLOT_FILTER}"
fi

@@prefix@@/bin/pivy-agent -i -g "$GUID" -K "$CAK" -a "$SOCKET" $OPTS &

exit $SMF_EXIT_OK
